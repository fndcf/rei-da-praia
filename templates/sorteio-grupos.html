{% extends "base.html" %}

{% block content %}
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="card-icon">üÉè</div>
        <div class="loading-text">Sorteando grupos...</div>
    </div>
    <div class="main-container">
        <h1 class="title">CONANS CUP</h1>

        <!-- Sistema de flash messages do Flask -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {{ 'erro' if category == 'error' or category == 'danger' else 'sucesso' if category == 'success' else 'alert-'+category }} mt-3 mb-3">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Exibir mensagens de erro antes do formul√°rio -->
        {% if erro_validacao %}
        <div class="erro mt-3 mb-3">
            {{ erro_validacao }}
        </div>
        {% endif %}
    
        <!-- Exibir mensagens de sucesso -->
        {% if sucesso_validacao %}
        <div class="sucesso mt-3 mb-3">
            {{ sucesso_validacao }}
        </div>
        {% endif %}
        
        <!-- Formul√°rio oculto para salvar todos os grupos - SEMPRE PRESENTE independente de condicionais -->
        <form id="formSalvarTodos" method="POST" action="{{ url_for('groups.salvar_todos_grupos') }}" style="display: none;"></form>
        
        {% if grupos %}
        <!-- Se j√° existem grupos, mostrar informa√ß√µes em vez do formul√°rio -->
        <div class="card card-sorteados" id="gruposSorteadosInfo">
            <div class="alert alert-info">
                <strong>Aten√ß√£o!</strong> Grupos j√° sorteados para este torneio.
            </div>
            <div class="text-center mt-3 mb-3">
                <p>Para realizar um novo sorteio, voc√™ precisa cancelar o torneio atual.</p>
                <form action="{{ url_for('main.cancelar_torneio') }}" method="get">
                    <button type="submit" class="btn btn-danger mt-2"
                            onclick="return confirm('Tem certeza que deseja cancelar este torneio? Todos os dados ser√£o perdidos.')">
                        Cancelar Torneio Atual
                    </button>
                </form>
            </div>
            <button id="btnTrocarJogador" class="btn btn-warning">
                Trocar Jogador de Grupo
            </button>
            <button id="btnSubstituirJogador" class="btn btn-info">
                Substituir Jogador
            </button>
        </div>
        {% else %}
        <!-- Formul√°rio de sorteio normal quando n√£o h√° grupos -->
        <form method="POST" action="{{ url_for('groups.sorteio') }}" id="formSorteio" class="card card-sorteio">
            <div class="form-group">
                <label for="modo_torneio" class="form-text">Formato do Torneio:</label>
                <select id="modo_torneio" name="modo_torneio" class="form-control" required>
                    <option value="">Selecione o formato</option>
                    <option value="20j" {% if modo_torneio == '20j' %}selected{% endif %}>20 Jogadores (5 grupos de 4)</option>
                    <option value="24j" {% if modo_torneio == '24j' %}selected{% endif %}>24 Jogadores (6 grupos de 4)</option>
                    <option value="28j" {% if modo_torneio == '28j' %}selected{% endif %}>28 Jogadores (7 grupos de 4)</option>
                    <option value="32j" {% if modo_torneio == '32j' %}selected{% endif %}>32 Jogadores (8 grupos de 4)</option>                   
                </select>
            </div>
            
            <div class="form-group">
                <p id="instrucoes">Insira os jogadores separados por v√≠rgula:</p>
                <textarea id="jogadores" name="jogadores" class="form-control" required
                    oninput="this.value = this.value.replace(/[^a-zA-Z√Ä-√∫0-9\s,]/g, '')" 
                    placeholder="Jogador1, Jogador2, Jogador3, ..."></textarea>
                <p id="contador-jogadores" class="counter">0 jogadores</p>
                
                <!-- Novo bot√£o para selecionar jogadores existentes -->
                <button type="button" id="btnSelecionarJogadores" class="btn btn-info mb-3">
                    Selecionar Jogadores Existentes
                </button>
            </div>
            
            <!-- Campo Nome do Torneio em um novo div form-group para ficar abaixo -->
            <div class="form-group">
                <label for="nome_torneio" class="form-text">Nome do Torneio:</label>
                <input type="text" id="nome_torneio" name="nome_torneio" class="form-control" required>
            </div>
              
            <button type="submit" class="btn btn-success" id="btnSortear">Sortear Grupos</button>
            
            <!-- Modal para sele√ß√£o de jogadores -->
            <div id="modalJogadores" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Selecionar Jogadores</h3>
                        <span class="modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="buscarJogador" class="form-control mb-2" 
                               placeholder="Buscar jogador...">
                        
                        <div class="jogadores-container">
                            <div class="jogadores-lista-container">
                                <div class="lista-header">
                                    <h4>Jogadores Dispon√≠veis</h4>
                                    <button type="button" id="btnSelecionarTodos" class="btn btn-sm btn-outline-primary">
                                        Selecionar Todos
                                    </button>
                                </div>
                                <div class="jogadores-lista" id="listaJogadores">
                                    <!-- Jogadores ser√£o carregados aqui via AJAX -->
                                    <p class="text-muted">Carregando jogadores...</p>
                                </div>
                            </div>
                            
                            <div class="jogadores-selecionados">
                                <h4>Jogadores Selecionados (<span id="contadorSelecionados">0</span>)</h4>
                                <ul id="jogadoresSelecionados" class="lista-selecionados"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="btnCancelarSelecao">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="btnConfirmarSelecao">Confirmar Sele√ß√£o</button>
                    </div>
                </div>
            </div>
        </form>
        {% endif %}
    </div>

    <!-- Trocar Jogador de grupo -->
    {% if grupos %}
    <!-- Modal para Troca de Jogadores -->
    <div id="modalTrocarJogador" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Trocar Jogador de Grupo</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="alert alert-info">Selecione <strong>um jogador</strong> para troc√°-lo aleatoriamente de grupo.</p>
                
                <div class="jogadores-container">
                    <div class="jogadores-lista-container">
                        <div class="lista-header">
                            <h4>Jogadores do Torneio</h4>
                        </div>
                        <div class="jogadores-lista" id="listaTrocaJogadores">
                            <!-- Lista de jogadores agrupados -->
                            {% for grupo_idx, grupo in enumerate(grupos) %}
                                <h5 class="mt-3">Grupo {{ grupo_idx + 1 }}</h5>
                                {% for jogador in grupo %}
                                    <div class="jogador-item" data-nome="{{ jogador.nome }}" data-id="{{ jogador.id }}" data-grupo="{{ grupo_idx }}">
                                        <input type="radio" name="jogador_trocar" value="{{ jogador.id }}">
                                        <span>{{ jogador.nome }}</span>
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnCancelarTroca">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarTroca">Sortear Troca</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Substitui√ß√£o de Jogador -->
    {% if grupos %}

    <!-- Modal para Substitui√ß√£o de Jogador -->
    <div id="modalSubstituirJogador" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Substituir Jogador</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="alert alert-info">Selecione <strong>um jogador</strong> do torneio para substitu√≠-lo.</p>
                
                <!-- Sele√ß√£o do jogador a ser substitu√≠do -->
                <div class="jogadores-lista" id="listaJogadoresSubstituir">
                    <!-- Lista de jogadores agrupados -->
                    {% for grupo_idx, grupo in enumerate(grupos) %}
                        <h5 class="mt-3">Grupo {{ grupo_idx + 1 }}</h5>
                        {% for jogador in grupo %}
                            <div class="jogador-item" data-nome="{{ jogador.nome }}" data-id="{{ jogador.id }}" data-grupo="{{ grupo_idx }}">
                                <input type="radio" name="jogador_substituir" value="{{ jogador.id }}">
                                <span>{{ jogador.nome }}</span>
                            </div>
                        {% endfor %}
                    {% endfor %}
                </div>
                
                <div class="form-group mt-4">
                    <h4>Substituir por:</h4>
                    
                    <div class="tabs-container">
                        <div class="tabs">
                            <div class="tab active" data-target="jogador-existente">Jogador existente</div>
                            <div class="tab" data-target="jogador-novo">Novo jogador</div>
                        </div>
                        
                        <div class="tab-content" id="jogador-existente">
                            <input type="text" id="buscarJogadorSubstituicao" class="form-control mb-2" 
                                placeholder="Digite para buscar jogadores que n√£o est√£o no torneio atual...">
                            
                            <div class="jogadores-lista" id="listaJogadoresExistentes">
                                <p class="text-muted">Comece a digitar para buscar jogadores dispon√≠veis...</p>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="jogador-novo" style="display: none;">
                            <input type="text" id="novoJogadorNome" class="form-control" 
                                placeholder="Digite o nome do novo jogador...">
                            <div id="validacao-novo-jogador" class="text-danger mt-1" style="display: none;">
                                Este jogador j√° est√° no torneio atual.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnCancelarSubstituicao">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarSubstituicao">Substituir Jogador</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Listagem de Grupos -->
    {% if grupos %}
    <div class="container">
        <h2 class="text-center mt-4">Grupos Sorteados - {{ grupos|length }} Grupos</h2>
        
        {% for grupo in grupos %}
        <div class="grupo card mt-2">
            <h3>Grupo {{ loop.index }}</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Jogador</th>
                        <th>Vit√≥rias</th>
                        <th>Saldo+</th>
                        <th>Saldo-</th>
                        <th>Saldo Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for jogador in grupo %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ jogador['nome'] }}</td>
                        <td>{{ jogador['vitorias'] }}</td>
                        <td>{{ jogador['saldo_a_favor'] }}</td>
                        <td>{{ jogador['saldo_contra'] }}</td>
                        <td class="{% if jogador['saldo_total'] > 0 %}positivo{% elif jogador['saldo_total'] < 0 %}negativo{% endif %}">
                            {{ jogador['saldo_total'] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if confrontos %}
    <div class="container">
        <h2 class="text-center mt-4">Confrontos</h2>        
               
        <!-- Formul√°rio oculto para salvar todos os grupos -->
        <form id="formSalvarTodos" method="POST" action="{{ url_for('groups.salvar_todos_grupos') }}" style="display: none;"></form>
        
        {% for grupo_idx, grupo_confrontos in enumerate(confrontos) %}
        <form method="POST" action="{{ url_for('groups.salvar_grupo', grupo_idx=grupo_idx) }}" class="card mt-2 form-grupo">
            <h3>Grupo {{ grupo_idx + 1 }}</h3>
            {% for confronto_idx, confronto in enumerate(grupo_confrontos) %}
            <div class="confronto">
                <div class="confronto-jogadores">
                    <span class="dupla">{{ confronto[0]['nome'] }} & {{ confronto[1]['nome'] }}</span>
                    <input class="saldo-inputs-esq"  
                           id="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaA_favor"
                           name="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaA_favor" 
                           value="{{ valores_salvos.get('grupo_{}_confronto_{}_duplaA_favor'.format(grupo_idx, confronto_idx), '') }}" 
                           min="0" max="7" maxlength="1" required
                           oninput="this.value = this.value.replace(/[^0-7]/g, '')">
                    <span class="vs">‚öîÔ∏è</span>
                    <input class="saldo-inputs-dir"  
                           id="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaB_favor"
                           name="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaB_favor" 
                           value="{{ valores_salvos.get('grupo_{}_confronto_{}_duplaB_favor'.format(grupo_idx, confronto_idx), '') }}" 
                           min="0" max="7" maxlength="1" required
                           oninput="this.value = this.value.replace(/[^0-7]/g, '')">
                    <span class="dupla">{{ confronto[2]['nome'] }} & {{ confronto[3]['nome'] }}</span>
                </div>
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary mt-2">Salvar Grupo {{ grupo_idx + 1 }}</button>
        </form>
        {% endfor %}

        <!-- Bot√£o Salvar Todos os Grupos -->
        <div class="text-center mb-3">
            <button type="button" id="btnSalvarTodos" class="btn btn-primary btn-lg">Salvar Jogos (Parciais ou Completos)</button>
        </div>

    </div>
    {% endif %}

    <!-- Bot√£o da Fase Eliminat√≥ria -->
    {% if grupos %}
    <div class="container text-center mt-4">
        <button id="btnAbrirEliminatoria" class="btn btn-success">
            <span id="btn-text">Abrir Fase Eliminat√≥ria</span>
        </button>
    </div>
    {% endif %}
</body>
{% endblock %}

{% block scripts %}
<script>

    // Adicionar detector de salvamento bem-sucedido
    document.getElementById('btnSalvarTodos')?.addEventListener('click', function() {
        // Salvar no sessionStorage que o usu√°rio acabou de salvar dados
        sessionStorage.setItem('dados_salvos_recentemente', 'true');
    });

    // No evento DOMContentLoaded, adicionar esta verifica√ß√£o
    const dadosSalvosRecentemente = sessionStorage.getItem('dados_salvos_recentemente');
    if (dadosSalvosRecentemente === 'true' && performance.getEntriesByType('navigation')[0].type === 'back_forward') {
        // Limpar o flag
        sessionStorage.removeItem('dados_salvos_recentemente');
        
        // Mostrar o alerta
        if (confirm('Voc√™ acabou de salvar dados e clicou em voltar. Os dados foram salvos, mas podem n√£o estar vis√≠veis. Deseja recarregar a p√°gina para ver os resultados atualizados?')) {
            window.location.reload();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {       
    
        // Verificar se elementos existem antes de tentar acess√°-los
        const modoSelect = document.getElementById('modo_torneio');
        const instrucoes = document.getElementById('instrucoes');
        const contador = document.getElementById('contador-jogadores');
        const textarea = document.getElementById('jogadores');
        const btnSortear = document.getElementById('btnSortear');
        const formSorteio = document.getElementById('formSorteio');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const btnCancelarTorneio = document.getElementById('btnCancelarTorneio');
        const btnSalvarTodos = document.getElementById('btnSalvarTodos');
        const btnAbrirEliminatoria = document.getElementById('btnAbrirEliminatoria');
        const btnSelecionarJogadores = document.getElementById('btnSelecionarJogadores');
        const btnSelecionarTodos = document.getElementById('btnSelecionarTodos');
        const buscarJogadorInput = document.getElementById('buscarJogador');
        const modalJogadores = document.getElementById('modalJogadores');
        const modalClose = document.querySelector('.modal-close');
        const btnCancelarSelecao = document.getElementById('btnCancelarSelecao');
        const btnConfirmarSelecao = document.getElementById('btnConfirmarSelecao');

        const btnTrocarJogador = document.getElementById('btnTrocarJogador');
        const modalTrocarJogador = document.getElementById('modalTrocarJogador');
        const modalCloseTroca = modalTrocarJogador?.querySelector('.modal-close');
        const btnCancelarTroca = document.getElementById('btnCancelarTroca');
        const btnConfirmarTroca = document.getElementById('btnConfirmarTroca');     
        
        // Elementos do modal de substitui√ß√£o
        const btnSubstituirJogador = document.getElementById('btnSubstituirJogador');
        const modalSubstituirJogador = document.getElementById('modalSubstituirJogador');
        const modalCloseSubstituir = modalSubstituirJogador?.querySelector('.modal-close');
        const btnCancelarSubstituicao = document.getElementById('btnCancelarSubstituicao');
        const btnConfirmarSubstituicao = document.getElementById('btnConfirmarSubstituicao');
        
        // Elementos das abas
        const tabs = modalSubstituirJogador?.querySelectorAll('.tab');
        const tabContents = modalSubstituirJogador?.querySelectorAll('.tab-content');
        
        // Elementos para busca e valida√ß√£o
        const buscarJogadorSubstituicao = document.getElementById('buscarJogadorSubstituicao');
        const novoJogadorNome = document.getElementById('novoJogadorNome');
        const validacaoNovoJogador = document.getElementById('validacao-novo-jogador');

    // Inicializa√ß√£o de vari√°veis
    let modoSubstituicao = 'jogador-existente'; // Padr√£o: substituir por jogador existente
    
    // Obter nomes de jogadores atuais do torneio para valida√ß√£o
    const jogadoresAtuais = [];
    document.querySelectorAll('#listaJogadoresSubstituir .jogador-item').forEach(item => {
        jogadoresAtuais.push(item.dataset.nome.toLowerCase());
    });

    // Abrir modal de substitui√ß√£o
    if (btnSubstituirJogador && modalSubstituirJogador) {
        btnSubstituirJogador.addEventListener('click', function() {
            // Limpar sele√ß√£o anterior
            const radios = document.querySelectorAll('input[name="jogador_substituir"]');
            radios.forEach(radio => radio.checked = false);
            
            // Limpar campos de busca e novo jogador
            if (buscarJogadorSubstituicao) buscarJogadorSubstituicao.value = '';
            if (novoJogadorNome) novoJogadorNome.value = '';
            if (validacaoNovoJogador) validacaoNovoJogador.style.display = 'none';
            
            // Resetar para a primeira aba
            if (tabs && tabs.length > 0) {
                tabs.forEach(tab => tab.classList.remove('active'));
                tabs[0].classList.add('active');
                
                if (tabContents) {
                    tabContents.forEach(content => content.style.display = 'none');
                    document.getElementById('jogador-existente').style.display = 'block';
                }
                
                modoSubstituicao = 'jogador-existente';
            }
            
            // Limpar lista de jogadores existentes
            const listaJogadoresExistentes = document.getElementById('listaJogadoresExistentes');
            if (listaJogadoresExistentes) {
                listaJogadoresExistentes.innerHTML = '<p class="text-muted">Comece a digitar para buscar jogadores dispon√≠veis...</p>';
            }
            
            // Abrir modal
            modalSubstituirJogador.style.display = 'flex';
        });
    }
    
    // Alternar entre as abas
    if (tabs) {
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const target = this.dataset.target;
                
                // Atualizar abas ativas
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Mostrar conte√∫do correspondente
                if (tabContents) {
                    tabContents.forEach(content => content.style.display = 'none');
                    document.getElementById(target).style.display = 'block';
                }
                
                modoSubstituicao = target;
            });
        });
    }
    
    // Fechar modal de substitui√ß√£o
    if (modalCloseSubstituir) {
        modalCloseSubstituir.addEventListener('click', function() {
            modalSubstituirJogador.style.display = 'none';
        });
    }
    
    if (btnCancelarSubstituicao) {
        btnCancelarSubstituicao.addEventListener('click', function() {
            modalSubstituirJogador.style.display = 'none';
        });
    }
    
    // Fechar modal ao clicar fora
    window.addEventListener('click', function(event) {
        if (event.target === modalSubstituirJogador) {
            modalSubstituirJogador.style.display = 'none';
        }
    });
    
    // Tratar clique nos itens de jogador (para facilitar a sele√ß√£o)
    document.querySelectorAll('#listaJogadoresSubstituir .jogador-item').forEach(item => {
        item.addEventListener('click', function() {
            // Encontrar o radio button dentro deste item
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
                // Desmarcar todos os outros
                document.querySelectorAll('input[name="jogador_substituir"]').forEach(r => r.checked = false);
                // Marcar este
                radio.checked = true;
            }
        });
    });
    
    // Buscar jogadores para substitui√ß√£o
    if (buscarJogadorSubstituicao) {
        buscarJogadorSubstituicao.addEventListener('input', function() {
            const termo = this.value.trim();
            
            // Se o termo tiver pelo menos 2 caracteres, buscar
            if (termo.length >= 2) {
                buscarJogadoresDisponiveis(termo);
            } else if (termo.length === 0) {
                // Se o termo estiver vazio, limpar a lista
                const listaJogadoresExistentes = document.getElementById('listaJogadoresExistentes');
                if (listaJogadoresExistentes) {
                    listaJogadoresExistentes.innerHTML = '<p class="text-muted">Comece a digitar para buscar jogadores dispon√≠veis...</p>';
                }
            }
        });
    }
    
    // Valida√ß√£o do nome do novo jogador
    if (novoJogadorNome) {
        novoJogadorNome.addEventListener('input', function() {
            const nome = this.value.trim().toLowerCase();
            
            if (nome.length > 0 && jogadoresAtuais.includes(nome)) {
                validacaoNovoJogador.style.display = 'block';
                btnConfirmarSubstituicao.disabled = true;
            } else {
                validacaoNovoJogador.style.display = 'none';
                btnConfirmarSubstituicao.disabled = false;
            }
        });
    }
    
    // Processar a substitui√ß√£o quando o bot√£o for clicado
    if (btnConfirmarSubstituicao) {
        btnConfirmarSubstituicao.addEventListener('click', function() {
            // Verificar se um jogador a ser substitu√≠do foi selecionado
            const radioSelecionado = document.querySelector('input[name="jogador_substituir"]:checked');
            
            if (!radioSelecionado) {
                alert('Por favor, selecione um jogador para substituir.');
                return;
            }
            
            // Obter o ID do jogador e seu grupo atual
            const jogadorItem = radioSelecionado.closest('.jogador-item');
            const jogadorId = jogadorItem.dataset.id;
            const grupoAtual = jogadorItem.dataset.grupo;
            const jogadorNomeAntigo = jogadorItem.dataset.nome;
            
            let novoJogadorId = null;
            let novoJogadorNomeVal = '';
            
            if (modoSubstituicao === 'jogador-existente') {
                // Verificar se um jogador existente foi selecionado
                const radioJogadorExistente = document.querySelector('input[name="jogador_substituicao"]:checked');
                
                if (!radioJogadorExistente) {
                    alert('Por favor, selecione um jogador existente para fazer a substitui√ß√£o.');
                    return;
                }
                
                novoJogadorId = radioJogadorExistente.value;
                novoJogadorNomeVal = radioJogadorExistente.dataset.nome;
            } else {
                // Verificar se um nome foi digitado para o novo jogador
                novoJogadorNomeVal = novoJogadorNome.value.trim();
                
                if (!novoJogadorNomeVal) {
                    alert('Por favor, digite um nome para o novo jogador.');
                    return;
                }
                
                // Verificar se o nome j√° existe no torneio
                if (jogadoresAtuais.includes(novoJogadorNomeVal.toLowerCase())) {
                    alert('Este jogador j√° est√° participando do torneio atual.');
                    return;
                }
            }
            
            // Mostrar carregamento
            btnConfirmarSubstituicao.disabled = true;
            btnConfirmarSubstituicao.innerHTML = '<span class="spinner">‚åõ</span> Processando...';
            
            // Fazer requisi√ß√£o para a API
            fetch('/substituir_jogador', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    jogador_id: jogadorId,
                    grupo_atual: grupoAtual,
                    jogador_existente: modoSubstituicao === 'jogador-existente',
                    novo_jogador_id: novoJogadorId,
                    novo_jogador_nome: novoJogadorNomeVal
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Exibir mensagem de sucesso
                    alert(`O jogador ${jogadorNomeAntigo} foi substitu√≠do por ${data.novo_jogador_nome} no Grupo ${parseInt(grupoAtual) + 1}.`);
                    
                    // Recarregar a p√°gina para mostrar os novos grupos
                    window.location.reload();
                } else {
                    throw new Error(data.error || 'Erro desconhecido ao substituir jogador.');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Falha ao substituir jogador: ' + error.message);
                btnConfirmarSubstituicao.disabled = false;
                btnConfirmarSubstituicao.innerHTML = 'Substituir Jogador';
            });
        });
    }
    
    // Fun√ß√£o para buscar jogadores dispon√≠veis
    function buscarJogadoresDisponiveis(termo) {
        const listaJogadoresExistentes = document.getElementById('listaJogadoresExistentes');
        if (!listaJogadoresExistentes) return;
        
        // Exibir estado de carregamento
        listaJogadoresExistentes.innerHTML = '<p class="text-center"><i>Buscando jogadores dispon√≠veis...</i></p>';
        
        // Fazer a requisi√ß√£o AJAX para buscar jogadores que n√£o est√£o no torneio atual
        fetch(`/buscar_jogadores_disponiveis?termo=${encodeURIComponent(termo)}`)
            .then(response => response.json())
            .then(data => {
                // Verificar se temos jogadores para exibir
                if (data.length === 0) {
                    listaJogadoresExistentes.innerHTML = '<p class="text-center">Nenhum jogador dispon√≠vel encontrado</p>';
                    return;
                }
                
                // Construir a lista de jogadores
                let html = '';
                data.forEach(jogador => {
                    html += `
                        <div class="jogador-item" data-nome="${jogador.nome}">
                            <input type="radio" name="jogador_substituicao" value="${jogador.id}" data-nome="${jogador.nome}">
                            <span>${jogador.nome}</span>
                        </div>
                    `;
                });
                
                listaJogadoresExistentes.innerHTML = html;
                
                // Adicionar evento de clique para os itens
                listaJogadoresExistentes.querySelectorAll('.jogador-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const radio = this.querySelector('input[type="radio"]');
                        if (radio) {
                            document.querySelectorAll('input[name="jogador_substituicao"]').forEach(r => r.checked = false);
                            radio.checked = true;
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Erro ao buscar jogadores:', error);
                listaJogadoresExistentes.innerHTML = '<p class="text-center text-danger">Erro ao buscar jogadores</p>';
            });
    }

    // Abrir modal de troca
    if (btnTrocarJogador && modalTrocarJogador) {
        btnTrocarJogador.addEventListener('click', function() {
            // Limpar sele√ß√£o anterior
            const radios = document.querySelectorAll('input[name="jogador_trocar"]');
            radios.forEach(radio => radio.checked = false);
            
            // Abrir modal
            modalTrocarJogador.style.display = 'flex';
        });
    }

    // Fechar modal de troca
    if (modalCloseTroca) {
        modalCloseTroca.addEventListener('click', function() {
            modalTrocarJogador.style.display = 'none';
        });
    }

    if (btnCancelarTroca) {
        btnCancelarTroca.addEventListener('click', function() {
            modalTrocarJogador.style.display = 'none';
        });
    }

    // Fechar modal ao clicar fora
    window.addEventListener('click', function(event) {
        if (event.target === modalTrocarJogador) {
            modalTrocarJogador.style.display = 'none';
        }
    });

    // Tratar clique nos itens de jogador (para facilitar a sele√ß√£o)
    document.querySelectorAll('#listaTrocaJogadores .jogador-item').forEach(item => {
        item.addEventListener('click', function() {
            // Encontrar o radio button dentro deste item
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
                // Desmarcar todos os outros
                document.querySelectorAll('input[name="jogador_trocar"]').forEach(r => r.checked = false);
                // Marcar este
                radio.checked = true;
            }
        });
    });

    // Processar a troca quando o bot√£o for clicado
    if (btnConfirmarTroca) {
        btnConfirmarTroca.addEventListener('click', function() {
            // Verificar se um jogador foi selecionado
            const radioSelecionado = document.querySelector('input[name="jogador_trocar"]:checked');
            
            if (!radioSelecionado) {
                alert('Por favor, selecione um jogador para trocar de grupo.');
                return;
            }
            
            // Obter o ID do jogador e seu grupo atual
            const jogadorItem = radioSelecionado.closest('.jogador-item');
            const jogadorId = jogadorItem.dataset.id;
            const grupoAtual = jogadorItem.dataset.grupo;
            const jogadorNome = jogadorItem.dataset.nome;
            
            // Mostrar carregamento
            btnConfirmarTroca.disabled = true;
            btnConfirmarTroca.innerHTML = '<span class="spinner">‚åõ</span> Processando...';
            
            // Fazer requisi√ß√£o para a API
            fetch('/trocar_jogador', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    jogador_id: jogadorId,
                    grupo_atual: grupoAtual
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Exibir mensagem de sucesso
                    alert(`O jogador ${jogadorNome} foi movido do Grupo ${parseInt(grupoAtual) + 1} para o Grupo ${data.novo_grupo + 1}.\n\nO jogador ${data.jogador_trocado_nome} foi movido para o Grupo ${parseInt(grupoAtual) + 1}.`);
                    
                    // Recarregar a p√°gina para mostrar os novos grupos
                    window.location.reload();
                } else {
                    throw new Error(data.error || 'Erro desconhecido ao trocar jogador.');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Falha ao trocar jogador: ' + error.message);
                btnConfirmarTroca.disabled = false;
                btnConfirmarTroca.innerHTML = 'Sortear Troca';
            });
        });
    }    


    // Verificar se temos grupos
    const existemGrupos = {% if grupos %}true{% else %}false{% endif %};
    
    // Funcionalidade do bot√£o Cancelar Torneio
    if (btnCancelarTorneio) {
        btnCancelarTorneio.addEventListener('click', function() {
            if (confirm('Tem certeza que deseja cancelar este torneio? Todos os dados ser√£o perdidos.')) {
                window.location.href = "{{ url_for('main.cancelar_torneio') }}";
            }
        });
    }

    // Funcionalidade do bot√£o Salvar Todos
    if (btnSalvarTodos) {
        btnSalvarTodos.addEventListener('click', function() {

            // Validar confrontos: esquerda e direita devem ser preenchidos juntos
            const inputsEsq = document.querySelectorAll('.saldo-inputs-esq');
            const inputsDir = document.querySelectorAll('.saldo-inputs-dir');

            const errosConfronto = [];
            let temConfrontoPreenchido = false;

            for (let i = 0; i < inputsEsq.length; i++) {
                const valorEsq = inputsEsq[i].value.trim();
                const valorDir = inputsDir[i].value.trim();

                const preenchidoEsq = valorEsq !== "";
                const preenchidoDir = valorDir !== "";

                if (preenchidoEsq && preenchidoDir) {
                    temConfrontoPreenchido = true; // pelo menos um par preenchido corretamente
                } else if (preenchidoEsq || preenchidoDir) {
                    errosConfronto.push(i + 1); // erro: preenchido s√≥ um lado
                }
            }

            if (errosConfronto.length > 0) {
                let mensagem = '‚ö†Ô∏è Preencha os dois lados (esquerdo e direito) para os seguintes confrontos:\n\n';
                errosConfronto.forEach(num => {
                    mensagem += `- Confronto ${num}\n`;
                });
                alert(mensagem);
                return;
            }

            if (!temConfrontoPreenchido) {
                alert("‚ö†Ô∏è Nenhum confronto foi preenchido. Por favor, preencha pelo menos um confronto completo antes de salvar.");
                return;
            }

            // Verificar se a fun√ß√£o validarSemEmpates existe
            if (typeof validarSemEmpates === 'function') {
                const empates = validarSemEmpates();
                if (empates.length > 0) {
                    // Montar mensagem de erro
                    let mensagem = '‚ö†Ô∏è N√£o √© permitido empate nos confrontos:\n\n';
                    empates.forEach(empate => {
                        mensagem += `Confronto ${empate.confronto}: ${empate.jogadoresEsq} x ${empate.jogadoresDir} (${empate.placar})\n`;
                    });
                    mensagem += '\nPor favor, corrija os resultados antes de salvar.';
                    
                    alert(mensagem);
                    
                    // Rolar at√© o primeiro empate
                    const primeiroInputComErro = document.querySelector('.erro-empate');
                    if (primeiroInputComErro) {
                        primeiroInputComErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        primeiroInputComErro.focus();
                    }
                    return;
                }
            }

            // Capturar todos os inputs de todos os grupos
            const formSalvarTodos = document.getElementById('formSalvarTodos');
            if (!formSalvarTodos) {
                console.error("Formul√°rio formSalvarTodos n√£o encontrado!");
                alert("Erro: Formul√°rio n√£o encontrado. Por favor, recarregue a p√°gina.");
                return;
            }
            
            formSalvarTodos.innerHTML = ''; // Limpar o formul√°rio
            
            // Selecionar todos os inputs com id que come√ßa com "grupo_"
            const todosInputs = document.querySelectorAll('input[id^="grupo_"]');
            
            // Adicionar cada input como um campo oculto no formul√°rio
            todosInputs.forEach(input => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = input.id;
                hiddenInput.value = input.value;
                formSalvarTodos.appendChild(hiddenInput);
            });

            // Submeter o formul√°rio
            formSalvarTodos.submit();
        });
    }

    // Bot√£o Abrir Fase Eliminat√≥ria
    if (btnAbrirEliminatoria) {
        // Salvar o estado original do bot√£o
        const textoOriginal = btnAbrirEliminatoria.textContent;
        
        // Adicionar detector para quando a p√°gina √© carregada do cache (bot√£o voltar)
        window.onpageshow = function(event) {
            if (event.persisted) {
                console.log("P√°gina carregada do cache (voltando da fase eliminat√≥ria)");
                
                // Verificar se o bot√£o est√° desabilitado
                if (btnAbrirEliminatoria.disabled) {
                    // Restaurar o bot√£o ao estado original
                    btnAbrirEliminatoria.disabled = false;
                    btnAbrirEliminatoria.innerHTML = textoOriginal;
                    
                    // Resetar resultados da fase eliminat√≥ria (simular clique no bot√£o resetar)
                    fetch('/resetar_eliminatorias', {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Resultados da eliminat√≥ria resetados com sucesso", data);
                    })
                    .catch(error => {
                        console.error("Erro ao resetar resultados:", error);
                    });
                }
            }
        };
        
        // O c√≥digo existente para o evento click
        btnAbrirEliminatoria.addEventListener('click', function(e) {
            e.preventDefault(); // Importante: previne o comportamento padr√£o
            
            // Primeiro validar se n√£o h√° empates
            const empates = (typeof validarSemEmpates === 'function') ? validarSemEmpates() : [];
            if (empates.length > 0) {
                // Montar mensagem de erro
                let mensagem = '‚ö†Ô∏è N√£o √© permitido empate nos confrontos:\n\n';
                empates.forEach(empate => {
                    mensagem += `Confronto ${empate.confronto}: ${empate.jogadoresEsq} x ${empate.jogadoresDir} (${empate.placar})\n`;
                });
                mensagem += '\nPor favor, corrija os resultados antes de avan√ßar.';
                
                alert(mensagem);
                
                // Rolar at√© o primeiro empate
                const primeiroInputComErro = document.querySelector('.erro-empate');
                if (primeiroInputComErro) {
                    primeiroInputComErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    primeiroInputComErro.focus();
                }
                return;
            }
            
            // Se n√£o houver empates, continuar verificando campos vazios
            const inputsVazios = document.querySelectorAll('.saldo-inputs-esq[value=""], .saldo-inputs-dir[value=""]');
            if (inputsVazios.length > 0) {
                // Destacar campos vazios
                inputsVazios.forEach(input => {
                    input.classList.add('campo-vazio');
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                // Focar no primeiro campo vazio
                inputsVazios[0]?.focus();

                // Alert mais informativo
                if (!confirm(`‚ö†Ô∏è Existem ${inputsVazios.length} resultados n√£o preenchidos. Voc√™ deve preencher todos os resultados antes de avan√ßar para a fase eliminat√≥ria. Deseja rolar para o primeiro campo vazio?`)) {
                    return;
                }
                return;
            }
            
            // Mostrar loading no bot√£o
            btnAbrirEliminatoria.disabled = true;
            btnAbrirEliminatoria.innerHTML = '<span class="spinner">‚åõ</span> Preparando fase eliminat√≥ria...';
            
            // Salvar em sessionStorage que o bot√£o foi clicado
            sessionStorage.setItem('eliminatoria_clicked', 'true');
            
            // IMPORTANTE: Primeiro resetar os dados da fase eliminat√≥ria
            fetch('/resetar_eliminatorias', {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Redirecionar com timestamp para evitar cache
                    const timestamp = new Date().getTime();
                    window.location.href = "/fase_eliminatoria?t=" + timestamp;
                } else {
                    throw new Error('Erro ao preparar fase eliminat√≥ria: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Falha na comunica√ß√£o com o servidor. Por favor, tente novamente. Erro: ' + error.message);
                btnAbrirEliminatoria.disabled = false;
                btnAbrirEliminatoria.innerHTML = textoOriginal;
                // Limpar estado salvo em caso de erro
                sessionStorage.removeItem('eliminatoria_clicked');
            });
        });
        
        // Verificar ao carregar a p√°gina se o bot√£o havia sido clicado
        if (sessionStorage.getItem('eliminatoria_clicked') === 'true') {
            // Se estamos voltando e o bot√£o havia sido clicado
            // Limpar o estado
            sessionStorage.removeItem('eliminatoria_clicked');
            
            // Restaurar o bot√£o ao estado original
            btnAbrirEliminatoria.disabled = false;
            btnAbrirEliminatoria.innerHTML = textoOriginal;
            
            // Fazer reset autom√°tico dos resultados
            fetch('/resetar_eliminatorias').then(r => r.json()).catch(e => console.error(e));
        }
    }

    // Mostrar overlay de loading quando enviar o formul√°rio
    if (formSorteio && loadingOverlay) {
        // Primeiro verificar se a p√°gina est√° sendo carregada do cache (bot√£o voltar)
        window.onpageshow = function(event) {
            if (event.persisted) {
                console.log("P√°gina carregada do cache (bot√£o voltar)");
                // Se o overlay estiver ativo, redirecionar para a home
                if (loadingOverlay.classList.contains('active')) {
                    window.location.href = "{{ url_for('main.home') }}";
                }
            }
        };
        
        // Salvar o estado do loading no sessionStorage
        window.addEventListener('beforeunload', function() {
            if (loadingOverlay.classList.contains('active')) {
                sessionStorage.setItem('loadingActive', 'true');
            }
        });
        
        // Verificar ao carregar a p√°gina se deveria estar em loading
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('loadingActive') === 'true') {
                // Se estiver voltando para a p√°gina e havia um loading ativo
                // Redirecionar para a home
                sessionStorage.removeItem('loadingActive');
                window.location.href = "{{ url_for('main.home') }}";
            }
        });
        
        // C√≥digo original do seu listener de submit
        formSorteio.addEventListener('submit', function(e) {
            // Verifica se o formul√°rio √© v√°lido
            if (this.checkValidity()) {
                // Mostra o overlay de loading
                loadingOverlay.classList.add('active');
                // Marca que estamos em estado de loading
                sessionStorage.setItem('loadingActive', 'true');
                    
                // Texto para mostrar durante o sorteio
                const loadingTexts = [
                    "Embaralhando jogadores...",
                    "Distribuindo entre os grupos...",
                    "Equilibrando os grupos...",
                    "Definindo confrontos...",
                    "Quase pronto..."
                ];
                    
                let currentText = 0;
                const loadingTextElement = loadingOverlay.querySelector('.loading-text');
                    
                // Alterna entre os textos para dar sensa√ß√£o de progresso
                const textInterval = setInterval(function() {
                    loadingTextElement.style.opacity = 0;
                        
                    setTimeout(function() {
                        loadingTextElement.textContent = loadingTexts[currentText];
                        loadingTextElement.style.opacity = 1;
                        currentText = (currentText + 1) % loadingTexts.length;
                    }, 300);
                }, 2000);
                    
                // Limpar intervalo se o usu√°rio navegar para fora da p√°gina
                window.addEventListener('beforeunload', function() {
                    clearInterval(textInterval);
                });
            }
        });
    }

    // Funcionalidades para o modal de sele√ß√£o de jogadores
    if (btnSelecionarJogadores && modalJogadores) {
        // Inicializar array para jogadores selecionados
        let selecionados = [];
        
        // Abrir modal e carregar jogadores
        btnSelecionarJogadores.addEventListener('click', function() {
            // Verificar se a textarea j√° tem jogadores
            if (textarea) {
                const jogadoresAtuais = textarea.value.split(',')
                    .map(nome => nome.trim())
                    .filter(nome => nome !== '');
                
                // Limpar a lista de selecionados atual
                selecionados = [...jogadoresAtuais];
                atualizarListaSelecionados();
            }
            
            // Abrir o modal
            modalJogadores.style.display = 'flex';
            
            // Carregar a lista de jogadores do banco de dados
            carregarJogadores();
        });
        
        // Fechar modal
        if (modalClose) {
            modalClose.addEventListener('click', function() {
                modalJogadores.style.display = 'none';
            });
        }
        
        if (btnCancelarSelecao) {
            btnCancelarSelecao.addEventListener('click', function() {
                modalJogadores.style.display = 'none';
            });
        }
        
        // Fechar modal ao clicar fora
        window.addEventListener('click', function(event) {
            if (event.target === modalJogadores) {
                modalJogadores.style.display = 'none';
            }
        });
        
        // Funcionalidade do bot√£o Selecionar Todos
        if (btnSelecionarTodos) {
            btnSelecionarTodos.addEventListener('click', function() {
                // Obter todos os itens de jogador atualmente exibidos na lista
                const jogadoresItems = document.querySelectorAll('.jogador-item');
                
                // Verificar se todos est√£o selecionados para determinar a a√ß√£o
                const todosJaSelecionados = Array.from(jogadoresItems).every(item => 
                    item.classList.contains('selecionado'));
                
                // Se todos j√° est√£o selecionados, vamos desselecion√°-los
                // Caso contr√°rio, selecionamos todos
                jogadoresItems.forEach(item => {
                    const nome = item.dataset.nome;
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    
                    if (todosJaSelecionados) {
                        // Desselecionando
                        if (selecionados.includes(nome)) {
                            selecionados = selecionados.filter(n => n !== nome);
                            item.classList.remove('selecionado');
                            checkbox.checked = false;
                        }
                    } else {
                        // Selecionando
                        if (!selecionados.includes(nome)) {
                            selecionados.push(nome);
                            item.classList.add('selecionado');
                            checkbox.checked = true;
                        }
                    }
                });
                
                // Atualizar o texto do bot√£o baseado na nova a√ß√£o
                this.textContent = todosJaSelecionados ? 'Selecionar Todos' : 'Desselecionar Todos';
                
                // Atualizar a lista de selecionados
                atualizarListaSelecionados();
            });
        }
        
        // Fun√ß√£o para carregar jogadores
        function carregarJogadores(termo = '') {
            const listaJogadores = document.getElementById('listaJogadores');
            if (!listaJogadores) return;
            
            // URL da API para buscar jogadores
            const url = termo 
                ? `{{ url_for('main.buscar_jogadores') }}?termo=${encodeURIComponent(termo)}` 
                : "{{ url_for('main.listar_todos_jogadores') }}";
            
            // Exibir estado de carregamento
            listaJogadores.innerHTML = '<p class="text-center"><i>Carregando jogadores...</i></p>';
            
            // Fazer a requisi√ß√£o AJAX
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Verificar se temos jogadores para exibir
                    if (data.length === 0) {
                        listaJogadores.innerHTML = '<p class="text-center">Nenhum jogador encontrado</p>';
                        return;
                    }
                    
                    // Construir a lista de jogadores
                    let html = '';
                    data.forEach(jogador => {
                        const jaSelecionado = selecionados.includes(jogador.nome);
                        html += `
                            <div class="jogador-item ${jaSelecionado ? 'selecionado' : ''}" 
                                 data-nome="${jogador.nome}" onclick="toggleJogador(this)">
                                <input type="checkbox" ${jaSelecionado ? 'checked' : ''}>
                                <span>${jogador.nome}</span>
                            </div>
                        `;
                    });
                    
                    listaJogadores.innerHTML = html;
                    
                    // Atualizar o texto do bot√£o Selecionar Todos
                    if (btnSelecionarTodos) {
                        // Verificar se todos os jogadores carregados j√° est√£o selecionados
                        const todosJaSelecionados = data.every(jogador => 
                            selecionados.includes(jogador.nome));
                        
                        btnSelecionarTodos.textContent = todosJaSelecionados ? 
                            'Desselecionar Todos' : 'Selecionar Todos';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar jogadores:', error);
                    listaJogadores.innerHTML = '<p class="text-center text-danger">Erro ao carregar jogadores</p>';
                });
        }
        
        // Filtrar jogadores
        if (buscarJogadorInput) {
            buscarJogadorInput.addEventListener('input', function() {
                const termo = this.value.trim();
                
                // Se o termo tiver pelo menos 2 caracteres, buscar
                if (termo.length >= 2) {
                    carregarJogadores(termo);
                } else if (termo.length === 0) {
                    // Se o termo estiver vazio, carregar todos
                    carregarJogadores();
                }
            });
        }
        
        // Confirmar sele√ß√£o 
        if (btnConfirmarSelecao && textarea && modoSelect) {
            btnConfirmarSelecao.addEventListener('click', function() {
                // Modo do torneio atual
                const modo = modoSelect.value;
                if (!modo) {
                    alert("Por favor, selecione o formato do torneio primeiro.");
                    return;
                }
                
                // N√∫mero esperado de jogadores
                let numEsperado;
                if (modo === '20j') {
                    numEsperado = 20;
                } else if (modo === '24j') {
                    numEsperado = 24;
                } else if (modo === '28j') {
                    numEsperado = 28;
                } else {
                    numEsperado = 32;
                }
                
                // Verificar se o n√∫mero de jogadores selecionados √© adequado
                if (selecionados.length > numEsperado) {
                    alert(`Voc√™ selecionou ${selecionados.length} jogadores, mas o formato escolhido requer exatamente ${numEsperado} jogadores.\n\nPor favor, remova ${selecionados.length - numEsperado} jogadores da sele√ß√£o.`);
                    return;
                }
                
                // Preencher a textarea com os jogadores selecionados
                textarea.value = selecionados.join(', ');
                
                // Fechar o modal
                modalJogadores.style.display = 'none';
                
                // Atualizar o contador de jogadores
                if (contador) {
                    contador.textContent = `${selecionados.length}/${numEsperado} jogadores`;
                    
                    // Feedback visual
                    contador.style.color = 
                        selecionados.length === numEsperado ? 'var(--success-color)' : 
                        selecionados.length > numEsperado ? 'var(--danger-color)' : 'var(--warning-color)';
                }
                
                // Disparar evento de input para validar a textarea
                textarea.dispatchEvent(new Event('input'));
            });
        }
        
        // Fun√ß√£o para atualizar a lista de jogadores selecionados
        function atualizarListaSelecionados() {
            const contadorSelecionados = document.getElementById('contadorSelecionados');
            const jogadoresSelecionados = document.getElementById('jogadoresSelecionados');
            
            if (!contadorSelecionados || !jogadoresSelecionados) return;
            
            // Atualizar o contador
            contadorSelecionados.textContent = selecionados.length;
            
            // Atualizar a lista visual
            jogadoresSelecionados.innerHTML = '';
            
            selecionados.forEach(nome => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${nome}</span>
                    <button type="button" onclick="removerSelecionado('${nome}')">√ó</button>
                `;
                jogadoresSelecionados.appendChild(li);
            });
        }
        
        // Expor fun√ß√µes necess√°rias no escopo global
        window.toggleJogador = function(element) {
            const nome = element.dataset.nome;
            const checkbox = element.querySelector('input[type="checkbox"]');
            
            // Toggle sele√ß√£o
            if (selecionados.includes(nome)) {
                // Remover da sele√ß√£o
                selecionados = selecionados.filter(n => n !== nome);
                element.classList.remove('selecionado');
                checkbox.checked = false;
            } else {
                // Adicionar √† sele√ß√£o
                selecionados.push(nome);
                element.classList.add('selecionado');
                checkbox.checked = true;
            }
            
            // Atualizar a lista de selecionados
            atualizarListaSelecionados();
        };
        
        window.removerSelecionado = function(nome) {
            // Remover da lista de selecionados
            selecionados = selecionados.filter(n => n !== nome);
            
            // Atualizar checkbox na lista principal
            const jogadorItem = document.querySelector(`.jogador-item[data-nome="${nome}"]`);
            if (jogadorItem) {
                jogadorItem.classList.remove('selecionado');
                jogadorItem.querySelector('input[type="checkbox"]').checked = false;
            }
            
            // Atualizar a lista de selecionados
            atualizarListaSelecionados();
        };
    }

    // Implementa√ß√£o da fun√ß√£o validarSemEmpates - definida no escopo global para ser acess√≠vel a outros handlers
    window.validarSemEmpates = function() {
        let empatesEncontrados = [];
        
        // Selecionar todos os confrontos
        const confrontos = document.querySelectorAll('.confronto');
        
        confrontos.forEach((confronto, index) => {
            const inputsEsq = confronto.querySelector('.saldo-inputs-esq');
            const inputsDir = confronto.querySelector('.saldo-inputs-dir');
            
            if (inputsEsq && inputsDir) {
                // Verificar se ambos os campos est√£o preenchidos
                if (inputsEsq.value !== '' && inputsDir.value !== '') {
                    const valorEsq = parseInt(inputsEsq.value);
                    const valorDir = parseInt(inputsDir.value);
                    
                    // Verificar se √© empate (agora permitindo 0, desde que n√£o seja empate)
                    if (valorEsq === valorDir) {
                        // Destacar inputs com erro
                        inputsEsq.classList.add('erro-empate');
                        inputsDir.classList.add('erro-empate');
                        
                        // Registrar o empate
                        const jogadoresEsq = confronto.querySelector('.dupla:first-child')?.textContent || 'Dupla 1';
                        const jogadoresDir = confronto.querySelector('.dupla:last-child')?.textContent || 'Dupla 2';
                        empatesEncontrados.push({
                            confronto: index + 1,
                            placar: `${valorEsq} x ${valorDir}`,
                            jogadoresEsq,
                            jogadoresDir
                        });
                    } else {
                        // Remover marca√ß√£o de erro
                        inputsEsq.classList.remove('erro-empate');
                        inputsDir.classList.remove('erro-empate');
                    }
                }
            }
        });
        
        return empatesEncontrados;
    };

    // Inicializar interface se necess√°rio
    if (modoSelect && textarea && btnSortear) {
        function atualizarInterface() {
            const modo = modoSelect.value;
            if (!modo) {
                if (instrucoes) instrucoes.textContent = "Selecione o formato do torneio primeiro";
                textarea.placeholder = "Selecione o formato acima";
                textarea.disabled = true;
                btnSortear.disabled = true;
                return;
            }
            
            let numJogadores;
            if (modo === '20j') {
                numJogadores = 20;
            } else if (modo === '24j') {
                numJogadores = 24;
            } else if (modo === '28j') {
                numJogadores = 28;
            } else {
                numJogadores = 32;
            }
            
            if (instrucoes) {
                instrucoes.textContent = `Insira EXATAMENTE ${numJogadores} jogadores √∫nicos separados por v√≠rgula:`;
            }
            textarea.placeholder = `Jogador1, Jogador2, ..., Jogador${numJogadores}`;
            textarea.disabled = false;
            btnSortear.disabled = false;
            
            // For√ßa a valida√ß√£o do textarea
            textarea.dispatchEvent(new Event('input'));
        }
        
        // Valida√ß√£o do textarea
        textarea.addEventListener('input', function() {
            const modo = modoSelect.value;
            if (!modo) return;
            
            let numEsperado;
            if (modo === '20j') {
                numEsperado = 20;
            } else if (modo === '24j') {
                numEsperado = 24;
            } else if (modo === '28j') {
                numEsperado = 28;
            } else {
                numEsperado = 32;
            }
            
            const nomes = this.value.split(',')
                .map(nome => nome.trim())
                .filter(nome => nome !== '' && nome.replace(/\s/g, '').length > 0);

            if (nomes.length === numEsperado) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                btnSortear.disabled = false;
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
                btnSortear.disabled = true;
            }
            
            // Verifica duplicados
            const nomesLower = nomes.map(nome => nome.toLowerCase());
            const duplicados = [...new Set(
                nomesLower.filter((nome, index) => nomesLower.indexOf(nome) !== index)
            )];
            
            // Atualiza contador
            if (contador) {
                contador.textContent = `${nomes.length}/${numEsperado} jogadores`;
                
                // Feedback visual
                if (duplicados.length > 0) {
                    contador.innerHTML += ` <span style="color:var(--danger-color)">(Duplicados: ${duplicados.join(', ')})</span>`;
                    contador.style.color = 'var(--danger-color)';
                    btnSortear.disabled = true;
                } else {
                    contador.style.color = 
                        nomes.length === numEsperado ? 'var(--success-color)' : 
                        nomes.length > numEsperado ? 'var(--danger-color)' : 'var(--warning-color)';
                    btnSortear.disabled = nomes.length !== numEsperado;
                }
            }
        });

        // Observa mudan√ßas no seletor
        modoSelect.addEventListener('change', atualizarInterface);

        // Inicializa a interface
        atualizarInterface();
    }

    // Adiciona valida√ß√£o na entrada de valores dos confrontos
    document.querySelectorAll('.saldo-inputs-esq, .saldo-inputs-dir').forEach(input => {
        input.addEventListener('change', function() {
            const confronto = this.closest('.confronto');
            if (!confronto) return;
            
            const inputEsq = confronto.querySelector('.saldo-inputs-esq');
            const inputDir = confronto.querySelector('.saldo-inputs-dir');
            
            if (!inputEsq || !inputDir) return;
            
            if (inputEsq.value && inputDir.value) {
                const valorEsq = parseInt(inputEsq.value);
                const valorDir = parseInt(inputDir.value);
                
                if (valorEsq === valorDir) {
                    inputEsq.classList.add('erro-empate');
                    inputDir.classList.add('erro-empate');
                    alert('N√£o √© permitido empate! Ambas as equipes devem ter pontua√ß√µes diferentes.');
                } else {
                    inputEsq.classList.remove('erro-empate');
                    inputDir.classList.remove('erro-empate');
                }
            }
        });
    });
    
    // Valida√ß√£o ao salvar o grupo
    document.querySelectorAll('.form-grupo').forEach(form => {
        form.addEventListener('submit', function(e) {
            const empates = window.validarSemEmpates();
            
            if (empates.length > 0) {
                e.preventDefault();
                
                // Montar mensagem de erro
                let mensagem = '‚ö†Ô∏è N√£o √© permitido empate nos confrontos:\n\n';
                empates.forEach(empate => {
                    mensagem += `Confronto ${empate.confronto}: ${empate.jogadoresEsq} x ${empate.jogadoresDir} (${empate.placar})\n`;
                });
                mensagem += '\nPor favor, corrija os resultados antes de salvar.';
                
                alert(mensagem);
                
                // Rolar at√© o primeiro empate
                const primeiroInputComErro = document.querySelector('.erro-empate');
                if (primeiroInputComErro) {
                    primeiroInputComErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    primeiroInputComErro.focus();
                }
            }
        });
    });
});



</script>
{% endblock %}