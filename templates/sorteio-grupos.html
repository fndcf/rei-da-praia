{% extends "base.html" %}

{% block content %}
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="card-icon">üÉè</div>
        <div class="loading-text">Sorteando grupos...</div>
    </div>
    <div class="main-container">
        <h1 class="title">Rei da Praia</h1>
        
        <form method="POST" action="{{ url_for('groups.sorteio') }}" id="formSorteio" class="card">
            <div class="form-group">
                <label for="modo_torneio" class="form-text">Formato do Torneio:</label>
                <select id="modo_torneio" name="modo_torneio" class="form-control" required>
                    <option value="">Selecione o formato</option>
                    <option value="20j" {% if modo_torneio == '20j' %}selected{% endif %}>20 Jogadores (5 grupos de 4)</option>
                    <option value="24j" {% if modo_torneio == '24j' %}selected{% endif %}>24 Jogadores (6 grupos de 4)</option>
                    <option value="28j" {% if modo_torneio == '28j' %}selected{% endif %}>28 Jogadores (7 grupos de 4)</option>
                    <option value="32j" {% if modo_torneio == '32j' %}selected{% endif %}>32 Jogadores (8 grupos de 4)</option>                   

                </select>
            </div>
            
            <div class="form-group">
                <p id="instrucoes">Insira os jogadores separados por v√≠rgula:</p>
                <textarea id="jogadores" name="jogadores" class="form-control" required
                    oninput="this.value = this.value.replace(/[^a-zA-Z√Ä-√∫0-9\s,]/g, '')" 
                    placeholder="Jogador1, Jogador2, Jogador3, ..."></textarea>
                <p id="contador-jogadores" class="counter">0 jogadores</p>
                <label for="nome_torneio" class="form-text">Nome do Torneio:</label>
                <input type="text" id="nome_torneio" name="nome_torneio" class="form-control" required>  
            </div>
              
            <button type="submit" class="btn btn-success" id="btnSortear">Sortear Grupos</button>
        </form>

        {% if session.get('erro_validacao') %}
        <div class="erro mt-3">
            {{ session['erro_validacao'] }}
        </div>
        {% endif %}
    </div>

    <!-- Listagem de Grupos -->
    {% if grupos %}
    <div class="container">
        <h2 class="text-center mt-4">Grupos Sorteados - {{ grupos|length }} Grupos</h2>
        
        {% for grupo in grupos %}
        <div class="grupo card mt-2">
            <h3>Grupo {{ loop.index }}</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Jogador</th>
                        <th>Vit√≥rias</th>
                        <th>Saldo+</th>
                        <th>Saldo-</th>
                        <th>Saldo Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for jogador in grupo %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ jogador['nome'] }}</td>
                        <td>{{ jogador['vitorias'] }}</td>
                        <td>{{ jogador['saldo_a_favor'] }}</td>
                        <td>{{ jogador['saldo_contra'] }}</td>
                        <td class="{% if jogador['saldo_total'] > 0 %}positivo{% elif jogador['saldo_total'] < 0 %}negativo{% endif %}">
                            {{ jogador['saldo_total'] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if confrontos %}
    <div class="container">
        <h2 class="text-center mt-4">Confrontos</h2>        
               
        <!-- Formul√°rio oculto para salvar todos os grupos -->
        <form id="formSalvarTodos" method="POST" action="{{ url_for('groups.salvar_todos_grupos') }}" style="display: none;"></form>
        
        {% for grupo_idx, grupo_confrontos in enumerate(confrontos) %}
        <form method="POST" action="{{ url_for('groups.salvar_grupo', grupo_idx=grupo_idx) }}" class="card mt-2 form-grupo">
            <h3>Grupo {{ grupo_idx + 1 }}</h3>
            {% for confronto_idx, confronto in enumerate(grupo_confrontos) %}
            <div class="confronto">
                <div class="confronto-jogadores">
                    <span class="dupla">{{ confronto[0]['nome'] }} & {{ confronto[1]['nome'] }}</span>
                    <input class="saldo-inputs-esq"  
                           id="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaA_favor"
                           name="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaA_favor" 
                           value="{{ valores_salvos.get('grupo_{}_confronto_{}_duplaA_favor'.format(grupo_idx, confronto_idx), '') }}" 
                           min="0" required
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <span class="vs">‚öîÔ∏è</span>
                    <input class="saldo-inputs-dir"  
                           id="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaB_favor"
                           name="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaB_favor" 
                           value="{{ valores_salvos.get('grupo_{}_confronto_{}_duplaB_favor'.format(grupo_idx, confronto_idx), '') }}" 
                           min="0" required
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <span class="dupla">{{ confronto[2]['nome'] }} & {{ confronto[3]['nome'] }}</span>
                </div>
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary mt-2">Salvar Grupo {{ grupo_idx + 1 }}</button>
        </form>
        {% endfor %}

        <!-- Bot√£o Salvar Todos os Grupos -->
        <div class="text-center mb-3">
            <button type="button" id="btnSalvarTodos" class="btn btn-primary btn-lg">Salvar Confrontos (Parciais ou Completos)</button>
        </div>

    </div>
    {% endif %}

    <!-- Bot√£o da Fase Eliminat√≥ria -->
    {% if grupos %}
    <div class="container text-center mt-4">
        <button id="btnAbrirEliminatoria" class="btn btn-warning">
            <span id="btn-text">Abrir Fase Eliminat√≥ria</span>
        </button>
    </div>
    {% endif %}
</body>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const modoSelect = document.getElementById('modo_torneio');
    const instrucoes = document.getElementById('instrucoes');
    const contador = document.getElementById('contador-jogadores');
    const textarea = document.getElementById('jogadores');
    const btnSortear = document.getElementById('btnSortear');

    
    // Mostrar overlay de loading quando enviar o formul√°rio
    const formSorteio = document.getElementById('formSorteio');
    const loadingOverlay = document.getElementById('loadingOverlay');

    if (formSorteio && loadingOverlay) {
        formSorteio.addEventListener('submit', function(e) {
            // Verifica se o formul√°rio √© v√°lido
            if (this.checkValidity()) {
                // Mostra o overlay de loading
                loadingOverlay.classList.add('active');
                    
                // Texto para mostrar durante o sorteio
                const loadingTexts = [
                    "Embaralhando jogadores...",
                    "Distribuindo entre os grupos...",
                    "Equilibrando os grupos...",
                    "Definindo confrontos...",
                    "Quase pronto..."
                ];
                    
                let currentText = 0;
                const loadingTextElement = loadingOverlay.querySelector('.loading-text');
                    
                // Alterna entre os textos para dar sensa√ß√£o de progresso
                const textInterval = setInterval(function() {
                    loadingTextElement.style.opacity = 0;
                        
                    setTimeout(function() {
                        loadingTextElement.textContent = loadingTexts[currentText];
                        loadingTextElement.style.opacity = 1;
                        currentText = (currentText + 1) % loadingTexts.length;
                    }, 300);
                }, 2000);
                    
                // Limpar intervalo se o usu√°rio navegar para fora da p√°gina
                window.addEventListener('beforeunload', function() {
                    clearInterval(textInterval);
                });
            }
        });
    }

    // Atualiza interface quando muda o modo
    function atualizarInterface() {
        console.log("Modo selecionado:", modoSelect.value);
        const modo = modoSelect.value;
        if (!modo) {
            instrucoes.textContent = "Selecione o formato do torneio primeiro";
            textarea.placeholder = "Selecione o formato acima";
            textarea.disabled = true;
            btnSortear.disabled = true;
            return;
        }
        
        let numJogadores;
        if (modo === '20j') {
            numJogadores = 20;
        } else if (modo === '24j') {
            numJogadores = 24;
        } else if (modo === '28j') {
            numJogadores = 28;
        } else {
            numJogadores = 32;
        }
        instrucoes.textContent = `Insira EXATAMENTE ${numJogadores} jogadores √∫nicos separados por v√≠rgula:`;
        textarea.placeholder = `Jogador1, Jogador2, ..., Jogador${numJogadores}`;
        textarea.disabled = false;
        btnSortear.disabled = false;
        
        // For√ßa a valida√ß√£o do textarea
        textarea.dispatchEvent(new Event('input'));
    }
    
    // Valida√ß√£o do textarea
    textarea.addEventListener('input', function() {
        const modo = modoSelect.value;
        if (!modo) return;
        
        let numEsperado;
        if (modo === '20j') {
            numEsperado = 20;
        } else if (modo === '24j') {
            numEsperado = 24;
        } else if (modo === '28j') {
            numEsperado = 28;
        } else {
            numEsperado = 32;
        }
        const nomes = this.value.split(',')
            .map(nome => nome.trim())
            .filter(nome => nome !== '' && nome.replace(/\s/g, '').length > 0);

        if (nomes.length === numEsperado) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
            btnSortear.disabled = false;
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
            btnSortear.disabled = true;
        }
        
        // Verifica duplicados
        const nomesLower = nomes.map(nome => nome.toLowerCase());
        const duplicados = [...new Set(
            nomesLower.filter((nome, index) => nomesLower.indexOf(nome) !== index)
        )];
        
        // Atualiza contador
        contador.textContent = `${nomes.length}/${numEsperado} jogadores`;
        
        // Feedback visual
        if (duplicados.length > 0) {
            contador.innerHTML += ` <span style="color:var(--danger-color)">(Duplicados: ${duplicados.join(', ')})</span>`;
            contador.style.color = 'var(--danger-color)';
            btnSortear.disabled = true;
        } else {
            contador.style.color = 
                nomes.length === numEsperado ? 'var(--success-color)' : 
                nomes.length > numEsperado ? 'var(--danger-color)' : 'var(--warning-color)';
            btnSortear.disabled = nomes.length !== numEsperado;
        }
    });
    
    // Observa mudan√ßas no seletor
    modoSelect.addEventListener('change', atualizarInterface);
    
    // Inicializa a interface
    atualizarInterface();

    // Tamb√©m precisamos modificar a fun√ß√£o de valida√ß√£o de empates para tratar corretamente o placar 0
    function validarSemEmpates() {
        let empatesEncontrados = [];
        
        // Selecionar todos os confrontos
        const confrontos = document.querySelectorAll('.confronto');
        
        confrontos.forEach((confronto, index) => {
            const inputsEsq = confronto.querySelector('.saldo-inputs-esq');
            const inputsDir = confronto.querySelector('.saldo-inputs-dir');
            
            if (inputsEsq && inputsDir) {
                // Verificar se ambos os campos est√£o preenchidos
                if (inputsEsq.value !== '' && inputsDir.value !== '') {
                    const valorEsq = parseInt(inputsEsq.value);
                    const valorDir = parseInt(inputsDir.value);
                    
                    // Verificar se √© empate (agora permitindo 0, desde que n√£o seja empate)
                    if (valorEsq === valorDir) {
                        // Destacar inputs com erro
                        inputsEsq.classList.add('erro-empate');
                        inputsDir.classList.add('erro-empate');
                        
                        // Registrar o empate
                        const jogadoresEsq = confronto.querySelector('.dupla:first-child')?.textContent || 'Dupla 1';
                        const jogadoresDir = confronto.querySelector('.dupla:last-child')?.textContent || 'Dupla 2';
                        empatesEncontrados.push({
                            confronto: index + 1,
                            placar: `${valorEsq} x ${valorDir}`,
                            jogadoresEsq,
                            jogadoresDir
                        });
                    } else {
                        // Remover marca√ß√£o de erro
                        inputsEsq.classList.remove('erro-empate');
                        inputsDir.classList.remove('erro-empate');
                    }
                }
            }
        });
        
        return empatesEncontrados;
    }

    // Adiciona valida√ß√£o na entrada de valores dos confrontos
    document.querySelectorAll('.saldo-inputs-esq, .saldo-inputs-dir').forEach(input => {
        input.addEventListener('change', function() {
            const confronto = this.closest('.confronto');
            const inputEsq = confronto.querySelector('.saldo-inputs-esq');
            const inputDir = confronto.querySelector('.saldo-inputs-dir');
            
            if (inputEsq.value && inputDir.value) {
                const valorEsq = parseInt(inputEsq.value);
                const valorDir = parseInt(inputDir.value);
                
                if (valorEsq === valorDir) {
                    inputEsq.classList.add('erro-empate');
                    inputDir.classList.add('erro-empate');
                    alert('N√£o √© permitido empate! Ambas as equipes devem ter pontua√ß√µes diferentes.');
                } else {
                    inputEsq.classList.remove('erro-empate');
                    inputDir.classList.remove('erro-empate');
                }
            }
        });
    });
    
    // Valida√ß√£o ao salvar o grupo
    document.querySelectorAll('.form-grupo').forEach(form => {
        form.addEventListener('submit', function(e) {
            const empates = validarSemEmpates();
            
            if (empates.length > 0) {
                e.preventDefault();
                
                // Montar mensagem de erro
                let mensagem = '‚ö†Ô∏è N√£o √© permitido empate nos confrontos:\n\n';
                empates.forEach(empate => {
                    mensagem += `Confronto ${empate.confronto}: ${empate.jogadoresEsq} x ${empate.jogadoresDir} (${empate.placar})\n`;
                });
                mensagem += '\nPor favor, corrija os resultados antes de salvar.';
                
                alert(mensagem);
                
                // Rolar at√© o primeiro empate
                const primeiroInputComErro = document.querySelector('.erro-empate');
                if (primeiroInputComErro) {
                    primeiroInputComErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    primeiroInputComErro.focus();
                }
            }
        });
    });

    // Adiciona verifica√ß√£o ao bot√£o de abrir eliminat√≥ria
    document.getElementById('btnAbrirEliminatoria')?.addEventListener('click', function(e) {
        // Primeiro validar se n√£o h√° empates
        const empates = validarSemEmpates();
        if (empates.length > 0) {
            e.preventDefault();
            
            // Montar mensagem de erro
            let mensagem = '‚ö†Ô∏è N√£o √© permitido empate nos confrontos:\n\n';
            empates.forEach(empate => {
                mensagem += `Confronto ${empate.confronto}: ${empate.jogadoresEsq} x ${empate.jogadoresDir} (${empate.placar})\n`;
            });
            mensagem += '\nPor favor, corrija os resultados antes de avan√ßar.';
            
            alert(mensagem);
            
            // Rolar at√© o primeiro empate
            const primeiroInputComErro = document.querySelector('.erro-empate');
            if (primeiroInputComErro) {
                primeiroInputComErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                primeiroInputComErro.focus();
            }
            return;
        }
        
        // Se n√£o houver empates, continuar verificando campos vazios
        const inputsVazios = document.querySelectorAll('.saldo-inputs-esq[value=""], .saldo-inputs-dir[value=""]');
        if (inputsVazios.length > 0) {
            e.preventDefault();
            
            // Destacar campos vazios
            inputsVazios.forEach(input => {
                input.classList.add('campo-vazio');
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
            // Focar no primeiro campo vazio
            inputsVazios[0]?.focus();

            // Alert mais informativo
            if (!confirm(`‚ö†Ô∏è Existem ${inputsVazios.length} resultados n√£o preenchidos. Voc√™ deve preencher todos os resultados antes de avan√ßar para a fase eliminat√≥ria. Deseja rolar para o primeiro campo vazio?`)) {
                return;
            }
        } else {
            // Todos preenchidos, pode abrir normalmente
            window.open(
                '{{ url_for("playoffs.fase_eliminatoria") }}',
                '_blank',
                'width=1000,height=700'
            );
        }
    });

    // L√≥gica para Salvar Todos os Grupos
    document.getElementById('btnSalvarTodos')?.addEventListener('click', function() {
        // Validar confrontos: esquerda e direita devem ser preenchidos juntos
        const inputsEsq = document.querySelectorAll('.saldo-inputs-esq');
        const inputsDir = document.querySelectorAll('.saldo-inputs-dir');

        const errosConfronto = [];
        let temConfrontoPreenchido = false;

        for (let i = 0; i < inputsEsq.length; i++) {
            const valorEsq = inputsEsq[i].value.trim();
            const valorDir = inputsDir[i].value.trim();

            const preenchidoEsq = valorEsq !== "";
            const preenchidoDir = valorDir !== "";

            if (preenchidoEsq && preenchidoDir) {
                temConfrontoPreenchido = true; // pelo menos um par preenchido corretamente
            } else if (preenchidoEsq || preenchidoDir) {
                errosConfronto.push(i + 1); // erro: preenchido s√≥ um lado
            }
        }

        if (errosConfronto.length > 0) {
            let mensagem = '‚ö†Ô∏è Preencha os dois lados (esquerdo e direito) para os seguintes confrontos:\n\n';
            errosConfronto.forEach(num => {
                mensagem += `- Confronto ${num}\n`;
            });
            alert(mensagem);
            return;
        }

        if (!temConfrontoPreenchido) {
            alert("‚ö†Ô∏è Nenhum confronto foi preenchido. Por favor, preencha pelo menos um confronto completo antes de salvar.");
            return;
        }
        // Verificar se h√° empates
        const empates = validarSemEmpates();
        if (empates.length > 0) {
            // Montar mensagem de erro
            let mensagem = '‚ö†Ô∏è N√£o √© permitido empate nos confrontos:\n\n';
            empates.forEach(empate => {
                mensagem += `Confronto ${empate.confronto}: ${empate.jogadoresEsq} x ${empate.jogadoresDir} (${empate.placar})\n`;
            });
            mensagem += '\nPor favor, corrija os resultados antes de salvar.';
            
            alert(mensagem);
            
            // Rolar at√© o primeiro empate
            const primeiroInputComErro = document.querySelector('.erro-empate');
            if (primeiroInputComErro) {
                primeiroInputComErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                primeiroInputComErro.focus();
            }
            return;
        }
        
        // Capturar todos os inputs de todos os grupos
        const formSalvarTodos = document.getElementById('formSalvarTodos');
        formSalvarTodos.innerHTML = ''; // Limpar o formul√°rio
        
        // Selecionar todos os inputs com id que come√ßa com "grupo_"
        const todosInputs = document.querySelectorAll('input[id^="grupo_"]');
        
        // Adicionar cada input como um campo oculto no formul√°rio
        todosInputs.forEach(input => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = input.id;
            
            // CORRE√á√ÉO: Usar valor real ou null/vazio, n√£o substituir campos vazios por '0'
            // Isso preserva a diferen√ßa entre um placar leg√≠timo de 0 e um campo n√£o preenchido
            hiddenInput.value = input.value;
            
            formSalvarTodos.appendChild(hiddenInput);
        });
        
        // Submeter o formul√°rio
        formSalvarTodos.submit();
    });
});
</script>
{% endblock %}