{% extends "base.html" %}

{% block content %}
<body>
    <div class="main-container">
        <h1 class="title">Rei da Praia</h1>
        
        <form method="POST" action="{{ url_for('groups.sorteio') }}" id="formSorteio" class="card">
            <div class="form-group">
                <label for="modo_torneio">Formato do Torneio:</label>
                <select id="modo_torneio" name="modo_torneio" class="form-control" required>
                    <option value="">Selecione o formato</option>
                    <option value="20j" {% if modo_torneio == '20j' %}selected{% endif %}>20 Jogadores (5 grupos de 4)</option>
                    <option value="24j" {% if modo_torneio == '24j' %}selected{% endif %}>24 Jogadores (6 grupos de 4)</option>
                    <option value="28j" {% if modo_torneio == '28j' %}selected{% endif %}>28 Jogadores (7 grupos de 4)</option>
                    <option value="32j" {% if modo_torneio == '32j' %}selected{% endif %}>32 Jogadores (8 grupos de 4)</option>                   

                </select>
            </div>
            
            <div class="form-group">
                <p id="instrucoes">Insira os jogadores separados por vírgula:</p>
                <textarea id="jogadores" name="jogadores" class="form-control" required
                    oninput="this.value = this.value.replace(/[^a-zA-ZÀ-ú0-9\s,]/g, '')" 
                    placeholder="Jogador1, Jogador2, Jogador3, ..."></textarea>
                <p id="contador-jogadores" class="counter">0 jogadores</p>
            </div>
            
            <button type="submit" class="btn btn-success" id="btnSortear">Sortear Grupos</button>
        </form>

        {% if session.get('erro_validacao') %}
        <div class="erro mt-3">
            {{ session['erro_validacao'] }}
        </div>
        {% endif %}
    </div>

    <!-- Listagem de Grupos -->
    {% if grupos %}
    <div class="container">
        <h2 class="text-center mt-4">Grupos Sorteados - {{ grupos|length }} Grupos</h2>
        
        {% for grupo in grupos %}
        <div class="grupo card mt-2">
            <h3>Grupo {{ loop.index }}</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Jogador</th>
                        <th>Vitórias</th>
                        <th>Saldo+</th>
                        <th>Saldo-</th>
                        <th>Saldo Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for jogador in grupo %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ jogador['nome'] }}</td>
                        <td>{{ jogador['vitorias'] }}</td>
                        <td>{{ jogador['saldo_a_favor'] }}</td>
                        <td>{{ jogador['saldo_contra'] }}</td>
                        <td class="{% if jogador['saldo_total'] > 0 %}positivo{% elif jogador['saldo_total'] < 0 %}negativo{% endif %}">
                            {{ jogador['saldo_total'] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Formulário de Confrontos -->
    {% if confrontos %}
    <div class="container">
        <h2 class="text-center mt-4">Confrontos</h2>
        
        {% for grupo_idx, grupo_confrontos in enumerate(confrontos) %}
        <form method="POST" action="{{ url_for('groups.salvar_grupo', grupo_idx=grupo_idx) }}" class="card mt-2">
            <h3>Grupo {{ grupo_idx + 1 }}</h3>
            {% for confronto_idx, confronto in enumerate(grupo_confrontos) %}
            <div class="confronto">
                <div class="confronto-jogadores">
                    <span class="dupla">{{ confronto[0]['nome'] }} & {{ confronto[1]['nome'] }}</span>
                    <input class="saldo-inputs-esq"  
                           name="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaA_favor" 
                           value="{{ valores_salvos.get('grupo_{}_confronto_{}_duplaA_favor'.format(grupo_idx, confronto_idx), '') }}" 
                           min="0" required
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <span class="vs">⚔️</span>
                    <input class="saldo-inputs-dir"  
                           name="grupo_{{ grupo_idx }}_confronto_{{ confronto_idx }}_duplaB_favor" 
                           value="{{ valores_salvos.get('grupo_{}_confronto_{}_duplaB_favor'.format(grupo_idx, confronto_idx), '') }}" 
                           min="0" required
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <span class="dupla">{{ confronto[2]['nome'] }} & {{ confronto[3]['nome'] }}</span>
                </div>
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary mt-2">Salvar Grupo {{ grupo_idx + 1 }}</button>
        </form>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Botão da Fase Eliminatória -->
    {% if grupos %}
    <div class="container text-center mt-4">
        <button id="btnAbrirEliminatoria" class="btn btn-warning">
            <span id="btn-text">Abrir Fase Eliminatória</span>
        </button>
    </div>
    {% endif %}
</body>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modoSelect = document.getElementById('modo_torneio');
        const instrucoes = document.getElementById('instrucoes');
        const contador = document.getElementById('contador-jogadores');
        const textarea = document.getElementById('jogadores');
        const btnSortear = document.getElementById('btnSortear');

        // Atualiza interface quando muda o modo
        function atualizarInterface() {
            console.log("Modo selecionado:", modoSelect.value);
            const modo = modoSelect.value;
            if (!modo) {
                instrucoes.textContent = "Selecione o formato do torneio primeiro";
                textarea.placeholder = "Selecione o formato acima";
                textarea.disabled = true;
                btnSortear.disabled = true;
                return;
            }
            
            let numJogadores;
            if (modo === '20j') {
                numJogadores = 20;
            } else if (modo === '24j') {
                numJogadores = 24;
            } else if (modo === '28j') {
                numJogadores = 28;
            } else {
                numJogadores = 32;
            }
            instrucoes.textContent = `Insira EXATAMENTE ${numJogadores} jogadores únicos separados por vírgula:`;
            textarea.placeholder = `Jogador1, Jogador2, ..., Jogador${numJogadores}`;
            textarea.disabled = false;
            btnSortear.disabled = false;
            
            // Força a validação do textarea
            textarea.dispatchEvent(new Event('input'));
        }
        
        // Validação do textarea
        textarea.addEventListener('input', function() {
            const modo = modoSelect.value;
            if (!modo) return;
            
            let numEsperado;
            if (modo === '20j') {
                numEsperado = 20;
            }  else if (modo === '24j') {
                numEsperado = 24;
            }  else if (modo === '28j') {
                numEsperado = 28;
            } else {
                numEsperado = 32;
            }
            const nomes = this.value.split(',')
                .map(nome => nome.trim())
                .filter(nome => nome !== '' && nome.replace(/\s/g, '').length > 0);

                if (nomes.length === numEsperado) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    btnSortear.disabled = false;
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    btnSortear.disabled = true;
                }
            
            // Verifica duplicados
            const nomesLower = nomes.map(nome => nome.toLowerCase());
            const duplicados = [...new Set(
                nomesLower.filter((nome, index) => nomesLower.indexOf(nome) !== index)
            )];
            
            // Atualiza contador
            contador.textContent = `${nomes.length}/${numEsperado} jogadores`;
            
            // Feedback visual
            if (duplicados.length > 0) {
                contador.innerHTML += ` <span style="color:var(--danger-color)">(Duplicados: ${duplicados.join(', ')})</span>`;
                contador.style.color = 'var(--danger-color)';
                btnSortear.disabled = true;
            } else {
                contador.style.color = 
                    nomes.length === numEsperado ? 'var(--success-color)' : 
                    nomes.length > numEsperado ? 'var(--danger-color)' : 'var(--warning-color)';
                btnSortear.disabled = nomes.length !== numEsperado;
            }
        });
        
        // Observa mudanças no seletor
        modoSelect.addEventListener('change', atualizarInterface);
        
        // Inicializa a interface
        atualizarInterface();

        // Adiciona verificação ao botão de abrir eliminatória
        document.getElementById('btnAbrirEliminatoria')?.addEventListener('click', function(e) {
            const inputsVazios = document.querySelectorAll('.saldo-inputs-esq[value=""], .saldo-inputs-dir[value=""]');
            if (inputsVazios.length > 0) {
                e.preventDefault();
                
                // Destacar campos vazios
                inputsVazios.forEach(input => {
                    input.classList.add('campo-vazio');
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                // Focar no primeiro campo vazio
                inputsVazios[0]?.focus();

                // Alert mais informativo
                if (!confirm(`⚠️ Existem ${inputsVazios.length} resultados não preenchidos. Você deve preencher todos os resultados antes de avançar para a fase eliminatória. Deseja rolar para o primeiro campo vazio?`)) {
                    return;
                }
            } else {
                // Todos preenchidos, pode abrir normalmente
                window.open(
                    '{{ url_for("playoffs.fase_eliminatoria") }}',
                    '_blank',
                    'width=1000,height=700'
                );
            }
        });


    });
</script>
{% endblock %}